<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin CMS - Blog</title>
  
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    body {
      background-color: #121212;
      color: white;
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: 40px auto;
      padding: 30px;
      background-color: #1e1e1e;
      border-radius: 10px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.3);
    }
    h2, h3 {
      text-align: center;
      color: #ffa500;
      margin-bottom: 30px;
    }
    label {
      display: block;
      margin: 15px 0 6px 2px;
      font-size: 0.95em;
      color: #ccc;
    }
    input, textarea {
      width: 100%;
      background: #2a2a2a;
      color: white;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 10px 15px;
      margin-bottom: 20px;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }
    input:focus, textarea:focus {
      outline: none;
      box-shadow: 0 0 5px #df2a00;
      border-color: #df2a00;
    }
    
    #editor-container {
      background: #fff;
      border-radius: 6px;
      color: black;
      min-height: 250px;
    }
    .ql-toolbar {
      border-top-left-radius: 6px;
      border-top-right-radius: 6px;
      background: #2a2a2a;
      border-color: #444 !important;
    }
    .ql-container {
      border-bottom-left-radius: 6px;
      border-bottom-right-radius: 6px;
      border-color: #444 !important;
      font-size: 16px;
    }
    .ql-snow .ql-stroke { stroke: #ccc; }
    .ql-snow .ql-picker-label { color: #ccc; }

    button {
      background-color: #df2a00;
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 1em;
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.2s ease;
      margin-top: 20px;
    }
    button:hover {
      background-color: #c12500;
    }
    table {
      width: 100%;
      max-width: 1000px;
      margin: 30px auto;
      text-align: left;
      border-collapse: collapse;
      background: #1c1c1c;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 14px 15px;
      border-bottom: 1px solid #2f2f2f;
      vertical-align: middle;
    }
    th {
      color: #ffa700;
      font-weight: 600;
      background: #222;
    }
    .action-btn {
        background: #333;
        border: 1px solid #555;
        color: #ffe082;
        margin-right: 10px;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .action-btn.delete-btn { color: #ff5252; }
    .action-btn:hover { background: #444; color: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Admin Login</h2>
    <div id="loginSection">
      <input type="email" id="adminEmail" placeholder="Email" />
      <input type="password" id="adminPassword" placeholder="Password" />
      <button id="loginBtn">Login</button>
    </div>
    <div id="blogFormSection" style="display:none;">
      <h2>Blog Content Manager</h2>
      <label for="title">Blog Title</label>
      <input id="title" type="text" placeholder="Enter the blog title" required />
      <label for="author">Author</label>
      <input id="author" type="text" placeholder="Enter the author's name" required />
      <label for="imageUrl">Blog Image URL</label>
      <input id="imageUrl" type="url" placeholder="https://example.com/image.jpg" required />
      <label for="description">Short Description (for blog cards)</label>
      <textarea id="description" placeholder="A brief summary for the blog list page" required></textarea>
      <label for="editor-container">Full Blog Content</label>
      <div id="editor-container"></div>
      <button id="postBtn">Post Blog</button>
    </div>
  </div>
<div class="table-container" style="overflow-x: auto;">
  <h3 style="margin-top: 40px;">Your Blog Posts</h3>
  <table id="blogTable">
    <thead>
      <tr><th>Title</th><th>Author</th><th>Actions</th></tr>
    </thead>
    <tbody id="blogList"></tbody>
  </table>
</div>

  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

  <script type="module">
    // --- THE FIX IS HERE ---
    // Import initialized services from your local config file
    import { auth, db } from './assets/firebase/firebase.js';

    // Import AUTH functions directly from the Firebase Auth SDK
    import { signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    
    // Import FIRESTORE functions directly from the Firebase Firestore SDK
    import { 
      collection, addDoc, serverTimestamp, getDocs, doc, 
      getDoc as getSingleDoc, updateDoc, deleteDoc, query, orderBy 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // --- End of Fix ---

    let quill;

    function initializeEditor() {
      const toolbarOptions = [
        [{ 'header': [1, 2, 3, false] }], ['bold', 'italic'],
        [{ 'list': 'bullet' }], ['link'], ['clean']
      ];
      quill = new Quill('#editor-container', { modules: { toolbar: toolbarOptions }, theme: 'snow' });
    }

    document.getElementById('loginBtn').addEventListener('click', () => {
      const email = document.getElementById("adminEmail").value;
      const password = document.getElementById("adminPassword").value;
      signInWithEmailAndPassword(auth, email, password)
        .then(() => alert("‚úÖ Login success"))
        .catch((error) => alert("‚ùå " + error.message));
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("blogFormSection").style.display = "block";
        document.querySelector(".table-container").style.display = "block";
        if (!quill) { initializeEditor(); }
        loadBlogsForAdmin();
      } else {
        document.getElementById("loginSection").style.display = "block";
        document.getElementById("blogFormSection").style.display = "none";
        document.querySelector(".table-container").style.display = "none";
      }
    });
    
    const postBtn = document.getElementById('postBtn');
    postBtn.addEventListener('click', handleFormSubmit);

    async function handleFormSubmit() {
        const blogId = postBtn.dataset.editingId;
        if (blogId) {
            await updateBlog(blogId);
        } else {
            await postNewBlog();
        }
    }

    async function postNewBlog() {
      const title = document.getElementById("title").value;
      const author = document.getElementById("author").value;
      const imageUrl = document.getElementById("imageUrl").value;
      const description = document.getElementById("description").value;
      const detailContent = quill.root.innerHTML;

      if (!title || !author || !imageUrl || !description || detailContent === '<p><br></p>') {
        alert("Please fill all fields, including the full blog content.");
        return;
      }

      try {
        await addDoc(collection(db, "blogs"), {
          title, author, imageUrl, description, detailContent,
          createdAt: serverTimestamp(),
        });
        alert("‚úÖ Blog posted successfully!");
        resetForm();
        loadBlogsForAdmin();
      } catch (err) { alert("‚ùå Failed to post blog: " + err.message); }
    };
    
    async function loadBlogsForAdmin() {
      const blogListElem = document.getElementById('blogList');
      blogListElem.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';
      const q = query(collection(db, 'blogs'), orderBy("createdAt", "desc"));
      const snapshot = await getDocs(q);

      if(snapshot.empty) {
        blogListElem.innerHTML = '<tr><td colspan="3">No blog posts found.</td></tr>';
        return;
      }

      blogListElem.innerHTML = snapshot.docs.map(docSnap => `
        <tr>
          <td>${escapeHTML(docSnap.data().title)}</td>
          <td>${escapeHTML(docSnap.data().author)}</td>
          <td>
            <button class="action-btn edit-btn" data-id="${docSnap.id}">‚úèÔ∏è Edit</button>
            <button class="action-btn delete-btn" data-id="${docSnap.id}">üóëÔ∏è Delete</button>
          </td>
        </tr>`).join('');
    }
    
    async function loadBlogForEditing(id) {
        const docRef = doc(db, 'blogs', id);
        const docSnap = await getSingleDoc(docRef);
        if (docSnap.exists()) {
            const blogData = docSnap.data();
            document.getElementById("title").value = blogData.title;
            document.getElementById("author").value = blogData.author;
            document.getElementById("imageUrl").value = blogData.imageUrl;
            document.getElementById("description").value = blogData.description;
            quill.root.innerHTML = blogData.detailContent || '';
            postBtn.innerText = "Update Blog";
            postBtn.dataset.editingId = id;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    async function updateBlog(id) {
        const title = document.getElementById("title").value;
        const author = document.getElementById("author").value;
        const imageUrl = document.getElementById("imageUrl").value;
        const description = document.getElementById("description").value;
        const detailContent = quill.root.innerHTML;

        try {
            const blogRef = doc(db, "blogs", id);
            await updateDoc(blogRef, { title, author, imageUrl, description, detailContent });
            alert("‚úÖ Blog updated successfully!");
            resetForm();
            loadBlogsForAdmin();
        } catch (err) { alert("‚ùå Failed to update blog: " + err.message); }
    }

    async function deleteBlog(id) {
      if (!confirm("Are you sure you want to permanently delete this blog post?")) return;
      try {
        await deleteDoc(doc(db, "blogs", id));
        alert("Blog deleted!");
        loadBlogsForAdmin();
      } catch (err) { alert("Error deleting blog: " + err.message); }
    }

    document.getElementById('blogList').addEventListener('click', async (e) => {
      const target = e.target.closest('button');
      if (!target) return;
      
      const id = target.dataset.id;
      if (target.classList.contains('edit-btn')) { await loadBlogForEditing(id); }
      if (target.classList.contains('delete-btn')) { await deleteBlog(id); }
    });

    function resetForm() {
        document.getElementById("title").value = "";
        document.getElementById("author").value = "";
        document.getElementById("imageUrl").value = "";
        document.getElementById("description").value = "";
        if (quill) { quill.setText(''); }
        const postBtn = document.getElementById("postBtn");
        postBtn.innerText = "Post Blog";
        delete postBtn.dataset.editingId;
    }
    
    function escapeHTML(str) {
      const p = document.createElement("p");
      p.textContent = str || '';
      return p.innerHTML;
    }
  </script>
</body>
</html>
